<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Megrim&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./style.css">
    <link rel="stylesheet" href="./checkboxes.css">
    <title>Necromunda Gang Tracker</title>
</head>
<body>
    <div class="topBar">
        <div class="gangRating">Gang Rating: <span id="gangRating"></span></div>
        <button class="addGanger">Add Member</button>
        <button class="saveGang">Save</button>
    </div>
    <!-- modals -->
     <div class="tutorialModal">
        <div class="tutorial step1">add gang <br>members &rarr;</div>
        <div class="tutorial step2 saveProgress">save your<br>progress &rarr;</div>
        <div class="tutorial step1 rollADice">roll &rarr; <br>dice &rarr;</div>
        <div class="tutorial step2 addName">&uarr; &uarr; &uarr; <br>add <br>ganger <br>name</div>
        <div class="tutorial step2 addType">add ganger <br>&darr; &darr; &darr; &darr; type</div>
        <div class="tutorial step2 adjustWounds">tap blood drops to <br>adjust flesh wounds <br>&darr; &darr; &darr; &darr;</div>
        <div class="tutorial step2 adjustStats">&uarr; &uarr; &uarr; adjust <br>ganger stat <br> values</div>
        <div class="tutorial step2 adjustStatus">&uarr; &uarr; &uarr; <br>tap status text<br>to change <br>ganger status</div>
        <div class="tutorial step2 adjustSkills">&uarr; &uarr; &uarr; &uarr; &uarr;<br>add skills <br>or injuries</div>
        <div class="tutorial step2 adjustWeapons">&uarr; &uarr; &uarr;<br>use item button<br> to add weapons <br>and items</div>
        <div class="tutorial step2 adjustCostExp">add ganger cost/exp<br>&darr; &darr; &darr; &darr; &darr;</div>
        <div class="tutorial step2 remGanger">&uarr; &uarr; &uarr;<br>&uarr; &uarr; &uarr;<br>remove <br>ganger</div>
     </div>
    <div class="killGangerModal">
        <div class="result">
            Are you sure you want to remove <p id="gangerToKill"></p> from your list of gangers?
            <button id="kill">Yes</button>
            <button id="abort">No</button>
        </div>
    </div>
    <div class="invEquipmentModal">
        <div class="result">
            <div class="options">
                <div class="weaponStat" id="weaponName"></div>
                <div class="weaponStat">
                    <span>distance:</span>
                    <div class="distanceHit">
                        <span id="distanceShort"></span>
                        <span id="distanceLong"></span>
                    </div>
                </div>
                <div class="weaponStat">
                    <span> to hit:</span>
                    <div class="distanceHit">
                        <span id="hitShort"></span>
                        <span id="hitLong"></span>
                    </div>
                </div>
                <div class="weaponStat" id="strength"></div>
                <div class="weaponStat" id="damage"></div>
                <div class="weaponStat" id="saveMod"></div>
                <div class="weaponStat" id="ammoRoll"></div>
                <div class="weaponStat" id="special"></div>
            </div>
            <div class="options roll">
                <p>roll to hit:</p>
                <p class="rolls">roll to hit:</p>
            </div>
            <div class="remove">remove item</div>
            <div class="closeItem">close</div>
        </div>
    </div>
    <div class="addEquipmentModal">
        <div>
            <div class="topRow">
                <span></span>
                <span></span>
                <span style="text-align: center;">range</span>
                <span style="text-align: center;">to hit</span>
                <span></span>
                <span></span>
                <span style="text-align: center;">save</span>
                <span style="text-align: center;">ammo</span>
                <span></span>
            </div>
            <div class="row ignore weaponStats">
                <span>item</span>
                <span>cost</span>
                <span>short</span>
                <span>long</span>
                <span>short</span>
                <span>long</span>
                <span>str</span>
                <span>dmg</span>
                <span>mod</span>
                <span>roll</span>
                <span>special effects</span>
            </div>
        </div>
        <div class="options" id="equipmentOptions">
            <div id="opistol" class="row ignore top">pistols</div>
            <div id="obasic" class="row ignore pistols">basic</div>
            <div id="ospecial" class="row ignore basics">special</div>
            <div id="oheavy" class="row ignore specials">heavy</div>
            <div id="ohand-to-hand" class="row ignore heavies">H-T-H</div>
            <div id="ogrenade" class="row ignore handToHands">grenades</div>
            <div class="row ignore grenades"></div>
        </div>
        <div class="close">Close menu</div>
    </div>
    <div class="skillsModal">
        <div class="result">
            <div class="skillList">
                <div class="skillOptions">
                </div>
                <div class="skillDescriptions">
                    description of skill
                </div>
            </div>
            <div class="addSkill">add skill</div>
            <div class="closeItem">close</div>
        </div>
    </div>
    <div class="skillsInfoModal">
        <div class="result">
            <div class="skillInjuryTitle">
            </div>
            <div class="skillInjuryDesc"></div>
            <div class="removeSkill">remove</div>
            <div class="closeSkill">close</div>
        </div>
    </div>
    <div class="diceRoller">
        <div class="diceResults">
            <div class="singleDiceRoll"></div>
            <div class="doubleDiceRoll"></div>
        </div>
        <div class="diceButtons">
            <div class="singleRoll rollButton">roll one</div>
            <div class="doubleRoll rollButton">roll two</div>
        </div>
        <div class="rollResult"></div>
    </div>
    <div class="largeDivider"></div>
    <!-- start gang info -->
    
</body>
<script type="module">
    // Import the functions you need from the SDKs you need

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries
    // Your web app's Firebase configuration

    const firebaseConfig = {
        apiKey: "AIzaSyAO9GmtY5gBB7tbER2fHaB7LunQ80eQ6Dg",
        authDomain: "escher-gang.firebaseapp.com",
        projectId: "escher-gang",
        storageBucket: "escher-gang.firebasestorage.app",
        messagingSenderId: "849333959217",
        appId: "1:849333959217:web:c291c9792196f6616df310"
    };

    const userID = localStorage.getItem("user");
    // Initialize Firebase

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const dbRef = ref(database, 'users/' + userID);

    let gang = [];
    const loadGang = gang => {
        if (gang.length > 0) {
            const tutorialBlocks = document.querySelectorAll('.tutorial');
            tutorialBlocks.forEach(block => block.remove());
        }
        gang.forEach((ganger, index) => {
            const memberNumber = index + 1;
            const gangMemberContainer = document.createElement('div');
            gangMemberContainer.classList.add(`gangMember`,`member${memberNumber}`)
            gangMemberContainer.innerHTML = `
                    <div class="memberNameAndType">
                        <div class="memberType">
                            <select name="type${memberNumber}" id="type${memberNumber}">
                                <option value="Gang Leader">Gang Leader</option>
                                <option value="Heavy">Heavy</option>
                                <option value="Ganger" default selected>Ganger</option>
                                <option value="Juve">Juve</option>
                            </select>
                        </div>
                        <div class="memberName">
                            <textarea id="name${memberNumber}">${ganger.name}</textarea>
                            <div class="memberNumber" id="member${memberNumber}">${memberNumber}</div>
                        </div>
                    </div>
                    <div class="statsSkillsAndItems">
                        <div class="statsAndItems">
                            <div class="characteristicsBox">
                                <div class="statsBox">
                                    <div class="stat">
                                        <span>M</span>
                                        <input class="move" type="number" min="1" max="10" value="${ganger.move}" id="move${memberNumber}">
                                    </div>
                                    <div class="stat">
                                        <span>WS</span>
                                        <input class="ws skill" type="number" min="1" max="10" value="${ganger.ws}" id="ws${memberNumber}">
                                    </div>
                                    <div class="stat">
                                        <span>BS</span>
                                        <input class="bs skill" type="number" min="1" max="10" value="${ganger.bs}" id="bs${memberNumber}">
                                    </div>
                                    <div class="stat">
                                        <span>S</span>
                                        <input class="strength" type="number" min="1" max="10" value="${ganger.strength}" id="strength${memberNumber}">
                                    </div>
                                    <div class="stat">
                                        <span>T</span>
                                        <input class="toughness" type="number" min="1" max="10" value="${ganger.toughness}" id="toughness${memberNumber}">
                                    </div>
                                    <div class="stat">
                                        <span>W</span>
                                        <input class="wounds" type="number" min="1" max="10" value="${ganger.wounds}" id="wounds${memberNumber}">
                                    </div>
                                    <div class="stat">
                                        <span>I</span>
                                        <input class="initiative" type="number" min="1" max="10" value="${ganger.initiative}" id="initiative${memberNumber}">
                                    </div>
                                    <div class="stat">
                                        <span>A</span>
                                        <input class="attacks" type="number" min="1" max="10" value="${ganger.attacks}" id="attacks${memberNumber}">
                                    </div>
                                    <div class="stat">
                                        <span>Ld</span>
                                        <input class="leadership" type="number" min="1" max="10" value="${ganger.leadership}" id="leadership${memberNumber}">
                                    </div>
                                </div>
                                <div class="fw" id="fw${memberNumber}">FW: </div>
                            </div>
                            <div class="equipmentBox" id="equipmentBox${memberNumber}">
                                <div class="addEquipment" id="add${memberNumber}">item</div>
                            </div>
                            <div class="costBox">
                                <span>cost</span>
                                <input class="gangerCost" id="cost${memberNumber}" type="text" value="0">
                            </div>
                            <div class="expBox">
                                <span>exp</span>
                                <input class="gangerExp" id="exp${memberNumber}" type="text" value="0">
                            </div>
                            <div class="removeBox">
                                <button class="gangerRemove" id="remove${memberNumber}" type="text" name="${ganger.name}">Kill</button>
                            </div>
                        </div>
                        <div class="gangerSkillsInjuries" id="gangerSkillsInjuries${memberNumber}">
                            <div class="addSkills" id="skills${memberNumber}">skills/injuries</div>
                        </div>
                    </div>
            `
            document.querySelector('body').appendChild(gangMemberContainer);

            document.getElementById(`type${memberNumber}`).value = `${ganger.type}`;
            const inventoryBox = document.getElementById(`equipmentBox${memberNumber}`);
            ganger.inventory.forEach((item, index) => {
                const invSpan = document.createElement('span');
                invSpan.innerText = item;
                inventoryBox.appendChild(invSpan);
                if (ganger.inventory[index+1] != undefined) {
                    inventoryBox.innerHTML += ` `;
                }
            });
            const gangerSkillBox = [];
            gangerSkillBox.push(document.querySelector(`#ws${memberNumber}`));
            gangerSkillBox.push(document.querySelector(`#bs${memberNumber}`));
            gangerSkillBox.forEach(member => {
                const gangMemberNumber = member.id[member.id.length -1];
                updateWSBS(member.value, gangMemberNumber);
                member.addEventListener('change', e => {
                    updateWSBS(e.target.value, gangMemberNumber);
                });
            });
            const addSkills = document.querySelectorAll('.addSkills');
            addSkills.forEach(button => {
                button.addEventListener('click', e => {
                    currentGangMember = e.target.parentElement.id[e.target.parentElement.id.length - 1];
                    const skillOptions = document.querySelector('.skillOptions');
                    skillOptions.innerHTML = ``;
                    for (let item in as) {
                        const skillName = document.createElement('span');
                        skillName.innerHTML = item;
                        skillName.addEventListener('click', () => {
                            document.querySelector('.skillDescriptions').innerHTML = as[item].description;
                            currentSelectedSkill = item;
                        });
                        skillOptions.appendChild(skillName);
                    }
                    skillsModal.style.display = 'flex';
                });
            });

            const skillBox = document.getElementById(`gangerSkillsInjuries${memberNumber}`);
            ganger.allSkills.forEach((skill, index) => {
                const skillSpan = document.createElement('span');
                skillSpan.innerText = skill;
                skillBox.appendChild(skillSpan);
                if (ganger.allSkills[index+1] != undefined) {
                    skillBox.innerHTML += ` `;
                }
            });
            const selectedSkills = document.querySelectorAll(`.gangerSkillsInjuries span`);
            selectedSkills.forEach(skill => displaySkillInfo(skill))

            document.getElementById(`add${memberNumber}`).addEventListener('click', e => {
                currentGangMember = e.target.id[e.target.id.length - 1];
                displayAddModal()
            });
        });

        const selections = document.querySelectorAll(`.equipmentBox span`);
        selections.forEach(selection => getDisplayInfo(selection));

        const memberStatuses = document.querySelectorAll('.gangMember .status');
        memberStatuses.forEach(member => {
            member.addEventListener('click', e => {
                const gangMemberBox = document.querySelector(`.member${e.target.id[e.target.id.length-1]}`);
                const status = document.querySelector(`#status${e.target.id[e.target.id.length-1]}`);
                const memberStatus = [...gangMemberBox.classList];
                if (memberStatus.includes('dead')) {
                    gangMemberBox.classList.remove('pinned', 'downed', 'dead');
                    status.innerHTML = 'status: normal';
                } else if (memberStatus.includes('downed')) {
                    gangMemberBox.classList.add('dead');
                    status.innerHTML = 'status: dead';
                } else if (memberStatus.includes('pinned')) {
                    gangMemberBox.classList.add('downed');
                    status.innerHTML = 'status: downed';
                } else {
                    gangMemberBox.classList.add('pinned');
                    status.innerHTML = 'status: pinned';
                }
            });
        });

        const killBoxes = document.querySelectorAll('.gangerRemove');
        killBoxes.forEach(box => box.addEventListener('click', (e) => {
            displayKillModal(e.target.id[e.target.id.length-1],e.target.name);
        }));
        calcGangRating()
    }

    const calcGangRating = () => {
       const gangRating = document.getElementById('gangRating');
       const gangerCost = document.querySelectorAll('.gangerCost');
       const gangerExp = document.querySelectorAll('.gangerExp');
       let totalGangRating = 0;
       gangerCost.forEach(ganger => totalGangRating += ~~ganger.value);
       gangerExp.forEach(ganger => totalGangRating += ~~ganger.value);
       gangRating.innerHTML = totalGangRating;
    }

    const killModal = document.querySelector('.killGangerModal');

    const hideKillModal = () => killModal.style.display = 'none';

    const displayKillModal = (number, name) => {
        hideAddModal();
        hideInvModal();
        document.getElementById('gangerToKill').innerText = name;
        killModal.style.display = 'flex';
        document.getElementById('kill').addEventListener('click', (e) => {
            removeGanger(number);
            e.stopImmediatePropagation();
        });
        document.getElementById('abort').addEventListener('click', () => hideKillModal());
    }

    const removeGanger = gangMemberNumber => {
        const memberToKill = document.querySelector(`.member${gangMemberNumber}`);
        memberToKill.remove();
        calcGangRating();
        hideKillModal();
    }

    get(dbRef).then((snapshot) => {

    if(snapshot.exists()){
        gang = snapshot.val();
        loadGang(gang);
    } else {
        console.log("No data available")
    }
    }).then(() => {
        calcGangRating();
    }).catch((error) => {
    console.log(error)
    });

    const saveState = [];

    const saveConfirmed = () => {
        document.querySelector('body').classList.add('saved');
        setTimeout(() => document.querySelector('body').classList.remove('saved'),3000)
    }

    const saveGang = () => {
        calcGangRating();
        const fullGang = document.querySelectorAll('.gangMember');
        fullGang.forEach((member, index) => {
            const memberData = {};
            memberData.name = document.getElementById(`name${index+1}`).value;
            memberData.type = document.getElementById(`type${index+1}`).value;
            memberData.move = document.getElementById(`move${index+1}`).value;
            memberData.ws = document.getElementById(`ws${index+1}`).value;
            memberData.bs = document.getElementById(`bs${index+1}`).value;
            memberData.strength = document.getElementById(`strength${index+1}`).value;
            memberData.toughness = document.getElementById(`toughness${index+1}`).value;
            memberData.wounds = document.getElementById(`wounds${index+1}`).value;
            memberData.initiative = document.getElementById(`initiative${index+1}`).value;
            memberData.attacks = document.getElementById(`attacks${index+1}`).value;
            memberData.leadership = document.getElementById(`leadership${index+1}`).value;
            memberData.cost = document.getElementById(`cost${index+1}`).value;
            memberData.exp = document.getElementById(`exp${index+1}`).value;
            memberData.inventory = [];
            const rawInventory = document.getElementById(`equipmentBox${index+1}`).innerText;
            const inventory = rawInventory.replace('item','').trim().split(' ');
            inventory.forEach(item => memberData.inventory.push(item));
            memberData.allSkills = [];
            const rawSkills = document.getElementById(`gangerSkillsInjuries${index+1}`).innerText;
            console.log({rawSkills})
            const finalSkills = rawSkills.replace(`skills/injuries`,'').trim().split(' ');
            console.log({finalSkills})
            finalSkills.forEach(item => memberData.allSkills.push(item));
            saveState.push(memberData);
        });
        saveConfirmed();
        return set(ref(database, 'users/' + userID), saveState);
    }

    document.querySelector('.saveGang').addEventListener('click', () => saveGang());
</script>
<!-- <script src="./dummySquad.js"></script> -->
<script src="./allEquipment.js"></script>
<script src="./allSkills.js"></script>
<script src="./inventoryModal.js"></script>
<script src="./rollToHit.js"></script>
<script src="./fleshWounds.js"></script>
<script src="./statusChange.js"></script>
<script src="./addGanger.js"></script>
<script src="./addEquipModal.js"></script>
<script src="./addSkillsModal.js"></script>
<script src="./calcGangRating.js"></script>
<script src="./calcCost.js"></script>
<script src="./collapseEquipModal.js"></script>
<script src="./diceRoller.js"></script>
</html>